{{ $img := .image }}
{{ $alt := .alt }}
{{ $class := .class }}
{{ $loading := .loading | default "lazy" }}

{{ $small := $img.Resize "400x q90" }}
{{ $medium := $img.Resize "800x q90" }}
{{ $large := $img.Resize "1200x q90" }}
{{ $xlarge := $img.Resize "1800x q90" }}
{{ $xxlarge := $img.Resize "2400x q90" }}
{{ $xxxlarge := $img.Resize "3200x q90" }}

{{ $smallWebp := $img.Resize "400x webp q90" }}
{{ $mediumWebp := $img.Resize "800x webp q90" }}
{{ $largeWebp := $img.Resize "1200x webp q90" }}
{{ $xlargeWebp := $img.Resize "1800x webp q90" }}
{{ $xxlargeWebp := $img.Resize "2400x webp q90" }}
{{ $xxxlargeWebp := $img.Resize "3200x webp q90" }}

<picture>
  <!-- WebP sources with proper breakpoints -->
  <source
    media="(min-width: 1920px)"
    srcset="{{ $xxlargeWebp.RelPermalink }} 1x, {{ $xxxlargeWebp.RelPermalink }} 2x"
    type="image/webp">
  <source
    media="(min-width: 1440px)"
    srcset="{{ $xlargeWebp.RelPermalink }} 1x, {{ $xxlargeWebp.RelPermalink }} 2x"
    type="image/webp">
  <source
    media="(min-width: 1024px)"
    srcset="{{ $largeWebp.RelPermalink }} 1x, {{ $xlargeWebp.RelPermalink }} 2x"
    type="image/webp">
  <source
    media="(min-width: 768px)"
    srcset="{{ $mediumWebp.RelPermalink }} 1x, {{ $largeWebp.RelPermalink }} 2x"
    type="image/webp">
  <source
    media="(min-width: 480px)"
    srcset="{{ $smallWebp.RelPermalink }} 1x, {{ $mediumWebp.RelPermalink }} 2x"
    type="image/webp">

  <!-- JPEG fallbacks with same breakpoints -->
  <source
    media="(min-width: 1920px)"
    srcset="{{ $xxlarge.RelPermalink }} 1x, {{ $xxxlarge.RelPermalink }} 2x">
  <source
    media="(min-width: 1440px)"
    srcset="{{ $xlarge.RelPermalink }} 1x, {{ $xxlarge.RelPermalink }} 2x">
  <source
    media="(min-width: 1024px)"
    srcset="{{ $large.RelPermalink }} 1x, {{ $xlarge.RelPermalink }} 2x">
  <source
    media="(min-width: 768px)"
    srcset="{{ $medium.RelPermalink }} 1x, {{ $large.RelPermalink }} 2x">
  <source
    media="(min-width: 480px)"
    srcset="{{ $small.RelPermalink }} 1x, {{ $medium.RelPermalink }} 2x">

  <!-- Fallback image - use medium size for better quality on all devices -->
  <img
    src="{{ $medium.RelPermalink }}"
    alt="{{ $alt }}"
    width="{{ $medium.Width }}"
    height="{{ $medium.Height }}"
    {{ with $class }}class="{{ . }}" {{ end }}
    loading="{{ $loading }}"
    decoding="async">
</picture>
